{{ block title }} {% if player.id_in_group == 1 %} Joueur A - Jeu de Confiance
{% else %} Joueur B - Jeu de Confiance {% endif %} {{ endblock }} {{ block
content }}

<div class="container">
  <div class="row">
    <!-- Section chat avec timer -->
    <div class="col-md-12 mb-4">
      <h4><span id="time_remaining">120</span>s restantes</h4>
      <div
        id="chat-container"
        style="display: flex; justify-content: space-between"
      >
        {{ if player.has_cheap_talk }}

        <div class="card" style="width: 48%">
          <div class="card-header">
            <h4>Discussion avec l'autre joueur</h4>
          </div>
          <div class="card-body">
            <div
              id="chat_history"
              class="border p-2 mb-3"
              style="height: 200px; overflow-y: auto"
            ></div>
            <div id="typing_indicator" class="text-muted small mb-2 d-none">
              <i>L'autre joueur est en train d'écrire...</i>
            </div>
            <form id="chat_form" onsubmit="return false;">
              <div class="input-group">
                <input
                  type="text"
                  id="chat_input"
                  class="form-control"
                  placeholder="Parler à l'autre joueur..."
                  disabled
                />
                <button
                  id="send_msg_button"
                  class="btn btn-outline-secondary"
                  type="button"
                  disabled
                >
                  Envoyer
                </button>
              </div>
            </form>
          </div>
        </div>

        {{ endif }} {{ if player.gpt_behavior != "Non" }}
        <div class="card" style="width: 48%">
          <div class="card-header">
            <h4>Discussion avec ChatGPT</h4>
          </div>
          <div class="card-body">
            <div
              id="chatgpt-box"
              class="border p-2 mb-3"
              style="height: 200px; overflow-y: auto"
            >
              {{ gpt_history }}
            </div>
            <form id="gpt-form" onsubmit="return false;">
              <div class="input-group">
                <input
                  id="user-gpt-input"
                  class="form-control"
                  type="text"
                  placeholder="Parler à ChatGPT..."
                  autocomplete="off"
                />
                <button id="send-gpt-button" class="btn btn-outline-secondary">
                  Envoyer
                </button>
              </div>
            </form>
          </div>
        </div>
        {{ endif }}
      </div>
      <div id="chat_disabled_message" class="text-muted small mt-2 d-none">
        Le temps de discussion est écoulé.
      </div>
      {{ if player.gpt_behavior != "Non" or player.has_cheap_talk }}
      <div class="alert alert-info mt-3">
        <strong>Note:</strong> Vous pouvez prendre votre décision avant ou après
        la fin du temps de communication. Il n'est pas nécessaire d'envoyer un
        message pour jouer.
      </div>
      {{ endif }}
    </div>

    <!-- Section principale du jeu -->
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          {% if player.id_in_group == 1 %}
          <h4>Vous êtes le Joueur A</h4>
          {% else %}
          <h4>Vous êtes le Joueur B</h4>
          {% endif %}
        </div>
        <div class="card-body">
          <!-- Section principale du jeu - Maintenant dans un form séparé -->
          <form id="game_form" onsubmit="return false;">
            {% if player.id_in_group == 1 %}
            <!-- Interface pour le Joueur A -->
            <div id="playerA_interface">
              <p>Vous avez {{ C.ENDOWMENT }} jetons.</p>
              <p>Combien souhaitez-vous envoyer au Joueur B?</p>
              <div class="form-group mb-3">
                <input
                  type="number"
                  id="amount_input"
                  class="form-control"
                  min="0"
                  max="{{ C.ENDOWMENT }}"
                  step="1"
                  required
                />
                <div class="invalid-feedback">
                  Veuillez entrer un montant entre 0 et {{ C.ENDOWMENT }}.
                </div>
              </div>
              <button id="send_button" class="btn btn-primary" type="button">
                Envoyer
              </button>
              <div id="waiting_message" class="mt-3 d-none">
                <p>
                  Vous avez envoyé <span id="sent_amount"></span> jetons. En
                  attente du Joueur B...
                </p>
              </div>
            </div>
            {% else %}
            <!-- Interface pour le Joueur B -->
            <div id="playerB_interface">
              <div id="waiting_for_A" class="mb-3">
                <p>En attente de l'envoi du Joueur A...</p>
              </div>
              <div id="received_amount_display" class="d-none">
                <p>
                  Le Joueur A vous a envoyé
                  <span id="received_amount"></span> jetons.
                </p>
                <p>
                  Ce montant a été multiplié par {{ C.MULTIPLIER }}, vous avez
                  donc reçu <span id="tripled_amount_1"></span> jetons.
                </p>
                <p>
                  Combien souhaitez-vous renvoyer au Joueur A? (entre 0 et
                  <span id="tripled_amount_2"></span> jetons)
                </p>
                <div class="form-group mb-3">
                  <input
                    type="number"
                    id="amount_back_input"
                    class="form-control"
                    min="0"
                    step="1"
                    required
                  />
                  <div class="invalid-feedback">
                    Veuillez entrer un montant valide.
                  </div>
                </div>
                <button
                  id="send_back_button"
                  class="btn btn-primary"
                  type="button"
                >
                  Renvoyer
                </button>
              </div>
            </div>
            {% endif %}
          </form>

          <!-- Résultats (cachés jusqu'à la fin du jeu) -->
          <div id="game_results" class="mt-4 d-none">
            <h5>Résultats finaux:</h5>
            <div id="final_results_content"></div>
            <button id="proceed_button" class="btn btn-success mt-3">
              Continuer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{ endblock }} {{ block scripts }}
<script>
  const has_chat_gpt = "{{player.gpt_behavior}}" != "Non";
  const has_cheap_talk = "{{player.has_cheap_talk}}" == "True";
  console.log("cheap talk: " + has_cheap_talk + " et gpt: " + has_chat_gpt);
  const inputGPT = document.getElementById("user-gpt-input");
  const buttonGPT = document.getElementById("send-gpt-button");
  const chatBoxGPT = document.getElementById("chatgpt-box");

  // ----- Partie ChatGPT -----
  if (has_chat_gpt) {
    buttonGPT.onclick = function () {
      event.preventDefault(); // empêche le submit

      const message = inputGPT.value.trim();
      if (!message) return;

      chatBoxGPT.innerText += `\n{{C.USER_PREFIX}}${message}`;
      chatBoxGPT.scrollTop = chatBoxGPT.scrollHeight;

      liveSend({ message: message, is_chat_gpt: true });

      inputGPT.value = "";
      inputGPT.focus();
    };

    // envoyer en appuyant sur Entrée
    inputGPT.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        buttonGPT.click();
        event.preventDefault();
      }
    });
  }

  // ----- Partie chat entre joueurs -----
  let expireTime = parseFloat("{{ group.expire_time }}");
  let timeRemaining;
  let chatTimer;
  let typingTimer;
  let isTyping = false;
  const doneTypingInterval = 1000;
  const roleIsPlayerA = js_vars.id_in_group === 1;
  let canProceed = false;

  // Fonction pour mettre à jour le timer du chat
  function updateChatTimer() {
    updateTimeRemaining();
    document.getElementById("time_remaining").textContent = timeRemaining;

    if (timeRemaining <= 0) {
      clearInterval(chatTimer);
      disableChat(true);
    }
  }

  function updateTimeRemaining() {
    const now = Date.now() / 1000;
    timeRemaining = Math.max(parseInt(expireTime - now), 0);
  }

  // Fonction pour désactiver le chat
  function disableChat(is_expired) {
    // is_expired : boolean = true si temps écoulé, faux si c'est le joueur A qui a envoyé
    const placeholder = is_expired
      ? "Temps écoulé"
      : "Joueur A a pris sa décision";
    if (has_cheap_talk) {
      document.getElementById("chat_input").disabled = true;
      document.getElementById("send_msg_button").disabled = true;
      document
        .getElementById("chat_disabled_message")
        .classList.remove("d-none");
      document.getElementById("chat_input").placeholder = placeholder;
    }
    if (has_chat_gpt) {
      inputGPT.disabled = true;
      buttonGPT.disabled = true;
      inputGPT.placeholder = placeholder;
    }
  }

  // Fonction pour envoyer un message
  function sendChatMessage() {
    const chatInput = document.getElementById("chat_input");
    const message = chatInput.value.trim();

    if (message !== "" && timeRemaining > 0) {
      // Envoyer le message avec le préfixe "Joueur A" ou "Joueur B" selon le rôle
      const playerPrefix = roleIsPlayerA ? "Joueur A" : "Joueur B";
      liveSend({
        message: message,
        player_type: playerPrefix,
      });

      chatInput.value = "";

      // Maintenir le focus sur le champ de chat
      chatInput.focus();

      if (isTyping) {
        doneTyping();
      }
    }
  }

  // Fonctions pour gérer l'indicateur de frappe
  function doneTyping() {
    isTyping = false;
    liveSend({ typing_status: false });
    clearTimeout(typingTimer);
  }

  // Initialisation lorsque la page est chargée
  document.addEventListener("DOMContentLoaded", function () {
    // Activer le chat
    if (has_cheap_talk) {
      document.getElementById("chat_input").disabled = false;
      document.getElementById("send_msg_button").disabled = false;
    }

    // Démarrer le timer
    chatTimer = setInterval(updateChatTimer, 1000);

    // Configurer les événements du chat
    if (has_cheap_talk) {
      document
        .getElementById("send_msg_button")
        .addEventListener("click", function (e) {
          e.preventDefault(); // Empêcher le comportement par défaut qui pourrait causer un défilement
          sendChatMessage();
        });

      const chatInput = document.getElementById("chat_input");
      chatInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          e.preventDefault(); // Empêcher le comportement par défaut du formulaire
          sendChatMessage();
          return;
        }

        if (!isTyping && timeRemaining > 0) {
          isTyping = true;
          liveSend({ typing_status: true });
        }

        clearTimeout(typingTimer);
        typingTimer = setTimeout(doneTyping, doneTypingInterval);
      });

      chatInput.addEventListener("blur", function () {
        clearTimeout(typingTimer);
        if (isTyping) {
          doneTyping();
        }
      });
    }

    // Configurer les événements du jeu
    if (roleIsPlayerA) {
      document
        .getElementById("send_button")
        .addEventListener("click", sendTokens);
    } else {
      document
        .getElementById("send_back_button")
        .addEventListener("click", sendTokensBack);
    }

    document
      .getElementById("proceed_button")
      .addEventListener("click", function () {
        document.getElementById("form").submit();
      });

    // Demander l'historique du chat
    liveSend({ request_chat_history: true });

    updateWhenRefreshingPage();
  });

  //refais les envois en cas de refresh
  function updateWhenRefreshingPage() {
    const amount_sent = js_vars.amount_sent;
    const amount_sent_back = js_vars.amount_sent_back;
    if (amount_sent != null) {
      disableChat(false);
      const data_sent = { status: "sent", amount_sent: amount_sent };
      const data_received = {
        status: "received",
        amount_sent: amount_sent,
        tripled_amount: amount_sent * js_vars.multiplier,
      };
      liveRecv(data_sent);
      liveRecv(data_received);
    }

    if (amount_sent_back != null) {
      const data_complete = {
        status: "complete",
        can_proceed: true,
        amount_sent: amount_sent,
        amount_sent_back: amount_sent_back,
        tripled_amount: amount_sent * js_vars.multiplier,
      };
      liveRecv(data_complete);
    }
  }
  // Fonctions pour le jeu de confiance
  function sendTokens() {
    const amountInput = document.getElementById("amount_input");
    const amount = parseInt(amountInput.value);

    if (isNaN(amount) || amount < 0 || amount > js_vars.endowment) {
      amountInput.classList.add("is-invalid");
      return;
    }

    amountInput.classList.remove("is-invalid");
    liveSend({ amount_sent: amount });

    document.getElementById("send_button").disabled = true;
    document.getElementById("sent_amount").textContent = amount;
    document.getElementById("waiting_message").classList.remove("d-none");
  }

  function sendTokensBack() {
    const amountBackInput = document.getElementById("amount_back_input");
    const maxAmount = parseInt(
      document.getElementById("tripled_amount_1").textContent
    );
    const amountBack = parseInt(amountBackInput.value);

    if (isNaN(amountBack) || amountBack < 0 || amountBack > maxAmount) {
      amountBackInput.classList.add("is-invalid");
      return;
    }

    amountBackInput.classList.remove("is-invalid");
    liveSend({ amount_sent_back: amountBack });
    document.getElementById("send_back_button").disabled = true;
  }

  // Fonction pour mettre à jour les résultats finaux
  function updateFinalResults(data) {
    const resultsDiv = document.getElementById("final_results_content");

    if (roleIsPlayerA) {
      const amountSent = data.amount_sent;
      const amountReceived = data.amount_sent_back;
      const finalBalance = js_vars.endowment - amountSent + amountReceived;

      resultsDiv.innerHTML = `
        <p>Vous avez envoyé ${amountSent} jetons au Joueur B.</p>
        <p>Le Joueur B vous a renvoyé ${amountReceived} jetons.</p>
        <p><strong>Votre solde final: ${finalBalance} jetons</strong></p>
      `;
    } else {
      const amountReceived = data.amount_sent;
      const tripledAmount = data.tripled_amount;
      const amountSentBack = data.amount_sent_back;
      const finalBalance = tripledAmount - amountSentBack;

      resultsDiv.innerHTML = `
        <p>Vous avez reçu ${tripledAmount} jetons (${amountReceived} × ${js_vars.multiplier}).</p>
        <p>Vous avez renvoyé ${amountSentBack} jetons au Joueur A.</p>
        <p><strong>Votre solde final: ${finalBalance} jetons</strong></p>
      `;
    }
  }

  // Gestion des messages live
  function liveRecv(data) {
    // Mise à jour du chat

    if (data.is_chat_gpt == true) {
      const reply = data.reply;

      chatBoxGPT.textContent += `\n{{C.BOT_PREFIX}}${reply}`;
      chatBoxGPT.scrollTop = chatBoxGPT.scrollHeight;
    }
    if (data.new_message || data.full_chat) {
      const chatHistory = document.getElementById("chat_history");

      // Fonction pour remplacer "Joueur 1" par "Joueur A" et "Joueur 2" par "Joueur B"
      function formatChatMessages(content) {
        return content
          .replace(/Joueur 1:/g, "Joueur A:")
          .replace(/Joueur 2:/g, "Joueur B:");
      }

      if (data.full_chat) {
        chatHistory.innerHTML = formatChatMessages(data.full_chat);
      } else if (data.new_message) {
        chatHistory.innerHTML += formatChatMessages(data.new_message);
      }

      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // Indicateur de frappe
    if (data.hasOwnProperty("other_player_typing")) {
      const typingIndicator = document.getElementById("typing_indicator");
      if (data.other_player_typing) {
        typingIndicator.classList.remove("d-none");
      } else {
        typingIndicator.classList.add("d-none");
      }
    }

    // Logique du jeu
    if (data.status === "sent" && roleIsPlayerA) {
      disableChat(false);
      document.getElementById("send_button").disabled = true;
      document.getElementById("sent_amount").textContent = data.amount_sent;
      document.getElementById("waiting_message").classList.remove("d-none");
    }

    if (data.status === "received" && !roleIsPlayerA) {
      disableChat(false);
      document.getElementById("waiting_for_A").classList.add("d-none");
      document
        .getElementById("received_amount_display")
        .classList.remove("d-none");
      document.getElementById("received_amount").textContent = data.amount_sent;
      document.getElementById("tripled_amount_1").textContent =
        data.tripled_amount;
      document.getElementById("tripled_amount_2").textContent =
        data.tripled_amount;
      document.getElementById("amount_back_input").max = data.tripled_amount;
    }

    if (data.status === "complete") {
      canProceed = data.can_proceed;
      document.getElementById("game_results").classList.remove("d-none");

      // Mettre à jour l'affichage des résultats
      updateFinalResults(data);

      if (canProceed) {
        document.getElementById("proceed_button").disabled = false;
      }
    }
  }
</script>
{{ endblock }}
